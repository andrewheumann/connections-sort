<!DOCTYPE html>
<html>
<head>
  <title>OCR Debug</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: white; }
    .row { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
    .col { flex: 1; min-width: 300px; }
    img, canvas { max-width: 100%; border: 1px solid #444; }
    pre { background: #333; padding: 10px; overflow: auto; max-height: 300px; font-size: 12px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 0; }
    h3 { color: #c4a052; }
  </style>
</head>
<body>
  <h1>OCR Debug Test</h1>

  <input type="file" id="input" accept="image/*">
  <button onclick="runTest()">Run OCR Test</button>

  <div class="row">
    <div class="col">
      <h3>Original Image</h3>
      <img id="original">
    </div>
    <div class="col">
      <h3>Cropped Grid</h3>
      <canvas id="cropped"></canvas>
    </div>
    <div class="col">
      <h3>Thresholded</h3>
      <canvas id="threshold"></canvas>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <h3>OCR Raw Text</h3>
      <pre id="rawText"></pre>
    </div>
    <div class="col">
      <h3>Extracted Words</h3>
      <pre id="words"></pre>
    </div>
    <div class="col">
      <h3>Valid Tiles</h3>
      <pre id="tiles"></pre>
    </div>
  </div>

  <h3>Expected (from test image):</h3>
  <pre>CREDIT, VILLAGER, CALLING, FIRST, BUSINESS, NAME, REPORT, NAMESAKE, DECIDER, PREMIUM, CRAFT, ECONOMY, LINE, CITE, TRADE, REFERENCE</pre>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const expected = ['CREDIT', 'VILLAGER', 'CALLING', 'FIRST', 'BUSINESS', 'NAME', 'REPORT', 'NAMESAKE', 'DECIDER', 'PREMIUM', 'CRAFT', 'ECONOMY', 'LINE', 'CITE', 'TRADE', 'REFERENCE'];

    const uiWords = [
      'CONNECTIONS', 'CONNECTION', 'CREATE', 'SHUFFLE', 'DESELECT', 'SUBMIT',
      'TODAY', 'ARCHIVE', 'PLAY', 'NYT', 'GAMES', 'MENU', 'GAME',
      'MISTAKES', 'REMAINING', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE',
      'NEXT', 'BACK', 'SHARE', 'RESULTS', 'VIEW', 'ALL', 'OF',
      'GROUPS', 'GROUP', 'CORRECT', 'INCORRECT', 'GUESS', 'GUESSES',
      'SETTINGS', 'HELP', 'HOW', 'TO', 'THE', 'AND', 'FOR', 'WITH'
    ];

    function isValidTile(text) {
      if (!text || text.length < 3 || text.length > 15) return false;
      if (uiWords.includes(text)) return false;
      if (/^\d+$/.test(text)) return false;
      return true;
    }

    async function runTest() {
      const file = document.getElementById('input').files[0];
      if (!file) return alert('Select an image first');

      const img = new Image();
      img.src = URL.createObjectURL(file);
      await new Promise(r => img.onload = r);

      document.getElementById('original').src = img.src;
      console.log('Image size:', img.width, 'x', img.height);

      // Crop to grid (adjustable percentages)
      const startY = Math.floor(img.height * 0.18);
      const endY = Math.floor(img.height * 0.62);
      const startX = Math.floor(img.width * 0.02);
      const endX = Math.floor(img.width * 0.98);
      const w = endX - startX;
      const h = endY - startY;

      console.log(`Crop: y=${startY}-${endY}, x=${startX}-${endX}, size=${w}x${h}`);

      const croppedCanvas = document.getElementById('cropped');
      croppedCanvas.width = w;
      croppedCanvas.height = h;
      const ctx1 = croppedCanvas.getContext('2d');
      ctx1.drawImage(img, startX, startY, w, h, 0, 0, w, h);

      // Threshold
      const threshCanvas = document.getElementById('threshold');
      threshCanvas.width = w;
      threshCanvas.height = h;
      const ctx2 = threshCanvas.getContext('2d');
      ctx2.drawImage(croppedCanvas, 0, 0);

      const imageData = ctx2.getImageData(0, 0, w, h);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
        const val = lum > 120 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = val;
      }
      ctx2.putImageData(imageData, 0, 0);

      // Run OCR
      document.getElementById('rawText').textContent = 'Running OCR...';

      const worker = await Tesseract.createWorker('eng');
      const result = await worker.recognize(threshCanvas);
      await worker.terminate();

      const rawText = result.data.text;
      document.getElementById('rawText').textContent = rawText;

      const words = rawText.toUpperCase().match(/[A-Z]{2,}/g) || [];
      document.getElementById('words').textContent = words.join(', ');

      const validTiles = words.filter(isValidTile);
      const found = validTiles.filter(t => expected.includes(t));
      const missing = expected.filter(t => !validTiles.includes(t));

      document.getElementById('tiles').textContent =
        `Found ${found.length}/16:\n${found.join(', ')}\n\nMissing:\n${missing.join(', ')}\n\nAll valid words:\n${validTiles.join(', ')}`;
    }
  </script>
</body>
</html>

